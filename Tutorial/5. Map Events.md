# 5. Map Events
In this part of the tutorial you will learn how to use MapBox Api events from map to interact with it. If you skipped something in previus parts, you can checkout branch 'tutorial-5-start'.
## 5.1 Hooking on events
There are two options how to hook and unhook onto events:
- on(type, function): first parameter is name of the event that triggers function in second parameter.
- off(type, function): first parameter is name of the event that should have function in second parameter removed from it.
- once(type, function): combination of previous two functions. Once the event triggers for the first time, it executes the function in the parameter and then unhooks this function from the event.
You can use on or once for hooking. Which one you do use depends on your use case. In case you are using on, it is important to remember that you need to call off when you don't need this hook anymore because it will be active untill you do, consuming resources and possibly causing memory leaks. Similar problem with memory leaks can happen if you have many once type hooks but the event never triggers and they stay there for the entire lifecycle of the application.
## 5.2 Lifecycle and data events
You can find list of all events [here](https://docs.mapbox.com/mapbox-gl-js/api/map/#map-events). We already used one event in part 4. of this tutorial. It was to hook onto 'load' event to prevent interacting with the map before it is finished loading and causing error. 'Idle' event is similar to 'load', only it fires after really everything is done, including loading map tiles and camera transitions. 'Load' event fires after the map is prepared to be interacted with from the code. Error event is another one of the lifecycle events. It fires every time there is an error instead of throwing an exception. You can use this event to catch the error and react accordingly or to log it. Last two events are 'webglcontextlost' and 'webglcontextrestored'. This happens when map loses connection to the mapbox server for any reason and is not able to load resources from there such as styles and map tiles.  

Data loading events are tied to finishing loading data such as styles, sources and images. You can use these to make sure you are not executing code relying on some resource before it is loaded.
## 5.3 Movement events
Movement events can be fired by both user interacting with the map and by code executing camera movement. These events come in pairs, one signaling start of the movement and second signaling the end. You can use these events to react on map camera moving. Now we will use 'zoomend' and 'moveend' to store camera position to local storage and then 'load' event to restore it after page reload.  

First step is to write function to store zoom level to local storage. To do that, we can simply store map properties for zoom to local storage like this:
```js
private storeZoom(): void {
  if (this.map == undefined) return;
  localStorage.setItem('mapZoom', this.map.getZoom().toString())
}
```
Then we can do similar thing for storing position of the center of the map:
```js
private storePosition(): void {
  if (this.map == undefined) return;
  localStorage.setItem('mapLatitude', this.map.getCenter().lat.toString())
  localStorage.setItem('mapLongitude', this.map.getCenter().lng.toString())
}
```
Now we need to hook these functions to map events. Note that they are accesing map property and we need to use 'bind(this)' to give these methods correct closure to have access to this property, otherwise it will be always undefined inside these functions called by event. We can hook onto the events like this:
```js
this.map.on('dragend', this.storePosition.bind(this));
this.map.on('zoomend', this.storeZoom.bind(this));
```
After doing this and moving and zooming the map you can see stored values in the browser developer tools:  
![image](https://github.com/dpastierovic/Geospatial-Application/assets/18383754/00644039-b4e5-4a99-af90-757263d148ac)  

Last thing remaining is to use these stored values in the ngOnInit() after instance of the map is created to restore it. This does not need to be hooked onto the 'load' event, because zoom and position are properties that can be changed without map being rendered. We can restore values like this:
```js
private restoreMapCamera(): void {
  if (this.map == undefined) return;

  let storedMapZoom = localStorage.getItem('mapZoom');
  let storedMapLatitude = localStorage.getItem('mapLatitude');
  let storedMapLongitude = localStorage.getItem('mapLongitude');

  if (storedMapZoom != null) {
    this.map.setZoom(Number.parseFloat(storedMapZoom));
  }

  if (storedMapLatitude != null && storedMapLongitude != null) {
    this.map.setCenter([Number.parseFloat(storedMapLongitude), Number.parseFloat(storedMapLatitude)]);
  }
}
```
And then call this method in ngOnInit() after map instance is created. Now when you move the map and reload the page or restart the application, camera position will be kept.
## 5.3 Mouse events
These events can be used to allow user interaction with the map. This can be used in a variety of ways, from using positions where user clicks on the map to change or add geometries on the map. In this part we will use clicks on empty place on map to add circle geometry we used in part 4 of this tutorial, and clicking existing point will remove it from the map. We will not persist this in any way across sessions so reloading will clear the map.  

To be able to read events properties we need to pass it as a parameter in our method hooked onto event. You can do it like this:
```js
private addPoint(e: mapboxgl.MapMouseEvent): void {
}
```  
You can checkout branch 'tutorial-5-end' to see finished code.
